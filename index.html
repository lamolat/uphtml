<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üìö Tr√¨nh xem HTML Online</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #controls {
      padding: 10px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    select, button {
      padding: 5px;
      font-size: 14px;
    }
    #viewer {
      width: 100%;
      height: calc(100% - 60px);
      border: none;
    }
    #dropzone {
      border: 2px dashed #aaa;
      padding: 20px;
      text-align: center;
      margin: 10px;
      background: #fff;
      cursor: pointer;
    }
    #pageInfo {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="dropzone">üìÇ K√©o & th·∫£ file HTML ho·∫∑c folder v√†o ƒë√¢y</div>
  <input type="file" id="fileInput" style="display:none" multiple webkitdirectory>
  <div id="controls">
    <label>M√¥n h·ªçc:</label>
    <select id="subjectSelect"></select>

    <label>Trang:</label>
    <select id="pageSelect"></select>

    <button onclick="prevPage()">‚¨ÖÔ∏è</button>
    <button onclick="nextPage()">‚û°Ô∏è</button>
    
    <span id="pageInfo">Trang 0 / 0</span>
    <button onclick="downloadCombinedHTML()">üì• T·∫£i v·ªÅ to√†n b·ªô</button>

  </div>

  <iframe id="viewer"></iframe>

  <script>
    let data = {};
    let currentSubject = '';
    let currentPage = 1;

    const dropzone = document.getElementById('dropzone');
    dropzone.addEventListener('dragover', e => e.preventDefault());
    dropzone.addEventListener('drop', handleDrop);

    function handleDrop(e) {
      e.preventDefault();
      const items = e.dataTransfer.items;
      for (let i = 0; i < items.length; i++) {
        const item = items[i].webkitGetAsEntry();
        if (item.isDirectory) {
          traverseDirectory(item, item.name);
        } else {
          const files = e.dataTransfer.files;
          for (let i = 0; i < files.length; i++) {
          const file = files[i];
          let subject = 'M·∫∑c ƒë·ªãnh';
          if (file.webkitRelativePath) {
          const parts = file.webkitRelativePath.split('/');
          if (parts.length > 1) subject = parts[0];
  }
  loadFile(file, subject);
}

        }
      }
    }

    function traverseDirectory(entry, folderName) {
      const reader = entry.createReader();
      reader.readEntries(entries => {
        entries.forEach(ent => {
          if (ent.isFile) {
            ent.file(file => loadFile(file, folderName));
          }
        });
      });
    }

    function loadFile(file, subject) {
      if (!file.name.endsWith('.html')) return;
      const reader = new FileReader();
      reader.onload = () => {
        if (!data[subject]) data[subject] = [];
        data[subject].push(reader.result);
        updateSubjects();
      };
      reader.readAsText(file);
    }

    function updateSubjects() {
      const subjectSelect = document.getElementById('subjectSelect');
      subjectSelect.innerHTML = '';
      for (const subject in data) {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectSelect.appendChild(option);
      }
      currentSubject = subjectSelect.value;
      loadPages();
    }

    function loadPages() {
      const pageSelect = document.getElementById('pageSelect');
      pageSelect.innerHTML = '';
      const pages = data[currentSubject];
      pages.forEach((_, i) => {
        const option = document.createElement('option');
        option.value = i + 1;
        option.textContent = (i + 1);
        pageSelect.appendChild(option);
      });
      currentPage = 1;
      updateViewer();
    }

    function updateViewer() {
      const html = data[currentSubject][currentPage - 1];
      const blob = new Blob([html], { type: 'text/html' });
      document.getElementById('viewer').src = URL.createObjectURL(blob);
      document.getElementById('pageSelect').value = currentPage;
      document.getElementById('pageInfo').textContent = "Trang " + currentPage + " / " + data[currentSubject].length;
    }

    document.getElementById('subjectSelect').onchange = () => {
      currentSubject = subjectSelect.value;
      loadPages();
    };
    document.getElementById('pageSelect').onchange = () => {
      currentPage = parseInt(pageSelect.value);
      updateViewer();
    };
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        updateViewer();
      }
    }
    function nextPage() {
      if (currentPage < data[currentSubject].length) {
        currentPage++;
        updateViewer();
      }
    }
    function downloadCombinedHTML() {
  if (!data[currentSubject] || data[currentSubject].length === 0) return;

  const subjectData = {};
  subjectData[currentSubject] = data[currentSubject];

  const folder_data = JSON.stringify(subjectData).replace(/<\/script>/g, "<\\/script>");

  const html = `
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>T·ªïng h·ª£p ${currentSubject}</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #controls { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; flex-wrap: wrap; }
    select, button { padding: 5px; font-size: 14px; }
    #viewer { width: 100%; height: calc(100% - 60px); border: none; }
    #pageInfo { font-weight: bold; }
  </style>
</head>
<body>
  <div id="controls">
    <label>M√¥n h·ªçc:</label>
    <select id="subjectSelect"></select>
    <label>Trang:</label>
    <select id="pageSelect"></select>
    <button onclick="prevPage()">‚¨ÖÔ∏è</button>
    <button onclick="nextPage()">‚û°Ô∏è</button>
    <span id="pageInfo">Trang 0 / 0</span>
  </div>
  <iframe id="viewer"></iframe>
  <script>
    const data = ${folder_data};
    let currentSubject = Object.keys(data)[0];
    let currentPage = 1;

    const subjectSelect = document.getElementById('subjectSelect');
    const pageSelect = document.getElementById('pageSelect');
    const viewer = document.getElementById('viewer');
    const pageInfo = document.getElementById('pageInfo');

    function loadSubjects() {
      subjectSelect.innerHTML = '';
      for (const subject in data) {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectSelect.appendChild(option);
      }
      currentSubject = subjectSelect.value;
      loadPages();
    }

    function loadPages() {
      pageSelect.innerHTML = '';
      const pages = data[currentSubject];
      pages.forEach((_, i) => {
        const option = document.createElement('option');
        option.value = i + 1;
        option.textContent = i + 1;
        pageSelect.appendChild(option);
      });
      currentPage = 1;
      updateViewer();
    }

    function updateViewer() {
      const html = data[currentSubject][currentPage - 1];
      const blob = new Blob([html], { type: 'text/html' });
      viewer.src = URL.createObjectURL(blob);
      pageSelect.value = currentPage;
      pageInfo.textContent = "Trang " + currentPage + " / " + data[currentSubject].length;
    }

    subjectSelect.onchange = () => {
      currentSubject = subjectSelect.value;
      loadPages();
    };
    pageSelect.onchange = () => {
      currentPage = parseInt(pageSelect.value);
      updateViewer();
    };
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        updateViewer();
      }
    }
    function nextPage() {
      if (currentPage < data[currentSubject].length) {
        currentPage++;
        updateViewer();
      }
    }

    loadSubjects();
  </script>
</body>
</html>
`;

  const blob = new Blob([html], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `tong_hop_${currentSubject}.html`;
  a.click();
}


  const fileInput = document.getElementById('fileInput');
  dropzone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      let subject = 'M·∫∑c ƒë·ªãnh';
      if (file.webkitRelativePath) {
        const parts = file.webkitRelativePath.split('/');
        if (parts.length > 1) subject = parts[0];
      }
      loadFile(file, subject);
    }
  });
  </script>
</body>
</html>
