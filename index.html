<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üìö Update multi HTML Online</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #controls {
      padding: 10px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    select, button, input {
      padding: 5px;
      font-size: 14px;
    }
    #viewer {
      width: 100%;
      height: calc(100% - 60px);
      border: none;
    }
    #dropzone {
      border: 2px dashed #aaa;
      padding: 20px;
      text-align: center;
      margin: 10px;
      background: #fff;
      cursor: pointer;
      position: relative;
    }
    #pageInfo {
      font-weight: bold;
    }
    #fileInput {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    #searchContainer {
      position: relative;
      display: flex;
      align-items: center;
    }
    #searchResults {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: white;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .search-result-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .search-result-item:hover {
      background-color: #f0f0f0;
    }
    .search-folder-name {
      font-weight: bold;
      color: #333;
    }
    .search-content-preview {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-controls {
      display: flex;
      align-items: center;
      gap: 5px;
    }
  </style>
</head>
<body>
  <div id="dropzone">
    <span>üìÇ K√©o & th·∫£ file HTML ho·∫∑c folder v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn file</span>
    <input type="file" id="fileInput" multiple webkitdirectory>
  </div>
  <div id="controls">
    <label>M√¥n h·ªçc:</label>
    <select id="subjectSelect"></select>

    <label>Trang:</label>
    <select id="pageSelect"></select>

    <button onclick="prevPage()">‚¨ÖÔ∏è</button>
    <button onclick="nextPage()">‚û°Ô∏è</button>
    
    <span id="pageInfo">Trang 0 / 0</span>
    
    <div id="searchContainer" class="search-controls">
      <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm...">
      <div id="searchResults"></div>
    </div>
    
    <label class="search-controls">
      <input type="checkbox" id="searchCurrentOnly"> 
      Ch·ªâ t√¨m trong folder hi·ªán t·∫°i
    </label>
    
    <button onclick="downloadCombinedHTML()">üì• T·∫£i v·ªÅ to√†n b·ªô</button>
  </div>

  <iframe id="viewer"></iframe>

  <script>
    let data = {};
    let currentSubject = '';
    let currentPage = 1;

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const searchCurrentOnlyCheckbox = document.getElementById('searchCurrentOnly');

    // X·ª≠ l√Ω s·ª± ki·ªán k√©o th·∫£
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.style.background = '#e0e0e0';
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.style.background = '#fff';
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.style.background = '#fff';
      handleDrop(e);
    });

    // X·ª≠ l√Ω khi click v√†o dropzone
    dropzone.addEventListener('click', (e) => {
      // NgƒÉn s·ª± ki·ªán click lan ƒë·∫øn file input
      if (e.target === dropzone || e.target.tagName === 'SPAN') {
        fileInput.click();
      }
    });

    // X·ª≠ l√Ω t√¨m ki·∫øm
    searchInput.addEventListener('input', handleSearch);
    searchInput.addEventListener('focus', handleSearch);
    
    // ƒê√≥ng k·∫øt qu·∫£ t√¨m ki·∫øm khi click ra ngo√†i
    document.addEventListener('click', (e) => {
      if (!searchContainer.contains(e.target)) {
        searchResults.style.display = 'none';
      }
    });

    function handleDrop(e) {
      const items = e.dataTransfer.items;
      if (!items) return;
      
      for (let i = 0; i < items.length; i++) {
        const entry = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : null;
        if (entry) {
          if (entry.isDirectory) {
            traverseDirectory(entry, entry.name);
          } else {
            const file = items[i].getAsFile();
            let subject = 'M·∫∑c ƒë·ªãnh';
            if (file.webkitRelativePath) {
              const parts = file.webkitRelativePath.split('/');
              if (parts.length > 1) subject = parts[0];
            }
            loadFile(file, subject);
          }
        }
      }
    }

    function traverseDirectory(entry, folderName) {
      const reader = entry.createReader();
      reader.readEntries(entries => {
        entries.forEach(ent => {
          if (ent.isFile && ent.name.endsWith('.html')) {
            ent.file(file => loadFile(file, folderName));
          } else if (ent.isDirectory) {
            traverseDirectory(ent, folderName);
          }
        });
      });
    }

    function loadFile(file, subject) {
      if (!file.name.endsWith('.html')) return;
      const reader = new FileReader();
      reader.onload = () => {
        if (!data[subject]) data[subject] = [];
        data[subject].push(reader.result);
        updateSubjects();
      };
      reader.readAsText(file);
    }

    function updateSubjects() {
      const subjectSelect = document.getElementById('subjectSelect');
      subjectSelect.innerHTML = '';
      for (const subject in data) {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectSelect.appendChild(option);
      }
      if (subjectSelect.options.length > 0) {
        currentSubject = subjectSelect.value;
        loadPages();
      }
    }

    function loadPages() {
      const pageSelect = document.getElementById('pageSelect');
      pageSelect.innerHTML = '';
      const pages = data[currentSubject];
      if (pages && pages.length > 0) {
        pages.forEach((_, i) => {
          const option = document.createElement('option');
          option.value = i + 1;
          option.textContent = (i + 1);
          pageSelect.appendChild(option);
        });
        currentPage = 1;
        updateViewer();
      }
    }

    function updateViewer() {
      if (!data[currentSubject] || data[currentSubject].length === 0) return;
      
      const html = data[currentSubject][currentPage - 1];
      const blob = new Blob([html], { type: 'text/html' });
      document.getElementById('viewer').src = URL.createObjectURL(blob);
      document.getElementById('pageSelect').value = currentPage;
      document.getElementById('pageInfo').textContent = "Trang " + currentPage + " / " + data[currentSubject].length;
    }

    document.getElementById('subjectSelect').onchange = () => {
      currentSubject = document.getElementById('subjectSelect').value;
      loadPages();
    };
    
    document.getElementById('pageSelect').onchange = () => {
      currentPage = parseInt(document.getElementById('pageSelect').value);
      updateViewer();
    };
    
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        updateViewer();
      }
    }
    
    function nextPage() {
      if (currentPage < data[currentSubject].length) {
        currentPage++;
        updateViewer();
      }
    }
    
    function handleSearch() {
      const keyword = searchInput.value.trim().toLowerCase();
      
      if (keyword === '') {
        searchResults.style.display = 'none';
        return;
      }
      
      const searchCurrentOnly = searchCurrentOnlyCheckbox.checked;
      const results = [];
      
      // Duy·ªát qua t·∫•t c·∫£ c√°c folder v√† trang ƒë·ªÉ t√¨m ki·∫øm
      for (const folder in data) {
        // N·∫øu ch·ªâ t√¨m trong folder hi·ªán t·∫°i, b·ªè qua c√°c folder kh√°c
        if (searchCurrentOnly && folder !== currentSubject) continue;
        
        const pages = data[folder];
        for (let i = 0; i < pages.length; i++) {
          const pageContent = pages[i].toLowerCase();
          if (pageContent.includes(keyword)) {
            // T√¨m th·∫•y k·∫øt qu·∫£, l·∫•y m·ªôt ƒëo·∫°n text xung quanh t·ª´ kh√≥a
            const index = pageContent.indexOf(keyword);
            const start = Math.max(0, index - 30);
            const end = Math.min(pageContent.length, index + keyword.length + 70);
            const preview = pageContent.substring(start, end).replace(/<[^>]*>/g, '');
            
            results.push({
              folder,
              pageIndex: i,
              preview: preview
            });
          }
        }
      }
      
      displaySearchResults(results);
    }
    
    function displaySearchResults(results) {
      searchResults.innerHTML = '';
      
      if (results.length === 0) {
        searchResults.innerHTML = '<div class="search-result-item">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
        searchResults.style.display = 'block';
        return;
      }
      
      results.forEach(result => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.innerHTML = `
          <div class="search-folder-name">${result.folder}</div>
          <div class="search-content-preview">${result.preview}</div>
        `;
        
        item.addEventListener('click', () => {
          // Chuy·ªÉn ƒë·∫øn folder v√† trang t∆∞∆°ng ·ª©ng
          currentSubject = result.folder;
          document.getElementById('subjectSelect').value = currentSubject;
          loadPages();
          currentPage = result.pageIndex + 1;
          updateViewer();
          
          // ƒê√≥ng k·∫øt qu·∫£ t√¨m ki·∫øm
          searchResults.style.display = 'none';
          searchInput.value = '';
        });
        
        searchResults.appendChild(item);
      });
      
      searchResults.style.display = 'block';
    }
    
    function downloadCombinedHTML() {
      if (!data[currentSubject] || data[currentSubject].length === 0) return;

      const subjectData = data; // L·∫•y to√†n b·ªô d·ªØ li·ªáu ƒë√£ upload

      const folder_data = JSON.stringify(subjectData).replace(/<\/script>/g, "<\\/script>");

      const html = `
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>T·ªïng h·ª£p</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #controls { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; flex-wrap: wrap; }
    select, button { padding: 5px; font-size: 14px; }
    #viewer { width: 100%; height: calc(100% - 60px); border: none; }
    #pageInfo { font-weight: bold; }
  </style>
</head>
<body>
  <div id="controls">
    <label>M√¥n h·ªçc:</label>
    <select id="subjectSelect"></select>
    <label>Trang:</label>
    <select id="pageSelect"></select>
    <button onclick="prevPage()">‚¨ÖÔ∏è</button>
    <button onclick="nextPage()">‚û°Ô∏è</button>
    <span id="pageInfo">Trang 0 / 0</span>
  </div>
  <iframe id="viewer"></iframe>
  <script>
    const data = ${folder_data};
    let currentSubject = Object.keys(data)[0];
    let currentPage = 1;

    const subjectSelect = document.getElementById('subjectSelect');
    const pageSelect = document.getElementById('pageSelect');
    const viewer = document.getElementById('viewer');
    const pageInfo = document.getElementById('pageInfo');

    function loadSubjects() {
      subjectSelect.innerHTML = '';
      for (const subject in data) {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectSelect.appendChild(option);
      }
      currentSubject = subjectSelect.value;
      loadPages();
    }

    function loadPages() {
      pageSelect.innerHTML = '';
      const pages = data[currentSubject];
      pages.forEach((_, i) => {
        const option = document.createElement('option');
        option.value = i + 1;
        option.textContent = i + 1;
        pageSelect.appendChild(option);
      });
      currentPage = 1;
      updateViewer();
    }

    function updateViewer() {
      const html = data[currentSubject][currentPage - 1];
      const blob = new Blob([html], { type: 'text/html' });
      viewer.src = URL.createObjectURL(blob);
      pageSelect.value = currentPage;
      pageInfo.textContent = "Trang " + currentPage + " / " + data[currentSubject].length;
    }

    subjectSelect.onchange = () => {
      currentSubject = subjectSelect.value;
      loadPages();
    };
    pageSelect.onchange = () => {
      currentPage = parseInt(pageSelect.value);
      updateViewer();
    };
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        updateViewer();
      }
    }
    function nextPage() {
      if (currentPage < data[currentSubject].length) {
        currentPage++;
        updateViewer();
      }
    }

    loadSubjects();
  <\/script>
</body>
</html>
`;

      const blob = new Blob([html], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `tong_hop.html`;
      a.click();
    }

    // X·ª≠ l√Ω s·ª± ki·ªán khi ch·ªçn file qua input
    fileInput.addEventListener('change', (e) => {
      const files = e.target.files;
      if (!files || files.length === 0) return;
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        let subject = 'M·∫∑c ƒë·ªãnh';
        if (file.webkitRelativePath) {
          const parts = file.webkitRelativePath.split('/');
          if (parts.length > 1) subject = parts[0];
        }
        loadFile(file, subject);
      }
    });
  </script>
</body>
</html>
